#include "variant.h"
#include <due_can.h>

#define SPEED                    CAN_BPS_125K
#define SAMPLING_POINT           1.4       // Add 1 to the sampling point

#define sda PIO_PC7
#define scl PIO_PC1

#define Serial SerialUSB

int counter = 0;
int counter2 = 0;
int stuffcnt = 0;
bool can_frame[27];
volatile bool sof = false;
bool start_counterattack = false;
uint16_t state = 0;
uint8_t len = 0;
volatile bool first_cycle = false;
volatile uint8_t retransmission_count = 0;

// Generated by canid_catch_less_than.py:
// using ECU CAN IDs: ['0x41', '0x42', '0x47', '0x48', '0x4a', '0x4b', '0x4c', '0x5a', '0x5c', '0x76', '0x77', '0x7d', '0x82', '0x83', '0x84', '0x85', '0x86', '0x87', '0x92', '0x139', '0x140', '0x14a', '0x156', '0x165', '0x166', '0x167', '0x171', '0x172', '0x178', '0x179', '0x185', '0x186', '0x200', '0x202', '0x204', '0x213', '0x214', '0x216', '0x217', '0x230', '0x231', '0x242', '0x263', '0x2e4', '0x2ec', '0x2f1', '0x326', '0x331', '0x332', '0x333', '0x344', '0x35e', '0x37b', '0x386', '0x38d', '0x3a8', '0x3aa', '0x3ab', '0x3b3', '0x3b4', '0x3b5', '0x3b6', '0x3b7', '0x3b8', '0x3c3', '0x3c7', '0x3da', '0x3e0', '0x3e1', '0x3e2', '0x3e3', '0x3ea', '0x3eb', '0x40a', '0x415', '0x416', '0x421', '0x424', '0x42c', '0x42d', '0x42f', '0x430', '0x434', '0x435', '0x436', '0x439', '0x43c', '0x43d', '0x43e', '0x446', '0x447', '0x455', '0x456', '0x4b0', '0x581', '0x595', '0x59e', '0x5a0', '0x5a2', '0x5b2', '0x5e2', '0x6a0', '0x6a1', '0x6a4', '0x6a5', '0x716', '0x71e', '0x723', '0x726', '0x72b', '0x72e', '0x736', '0x73e', '0x746', '0x74e', '0x7d0', '0x7d8', '0x7df', '0x7e0', '0x7e1', '0x7e8', '0x7e9']
// built for ECU bus ID: 0x7e9
void state_machine_run(uint8_t value) {
  
  bitWrite(state, 10 - len, value);
  len++;
  
  if (state > 2025) {
    return;
  }
  if (len == 11 && state == 2025) {
    start_counterattack = true;
    return;
  }
  if (len == 4 && state == 1280) {
    start_counterattack = true;
    return;
  }
  if (len == 4 && state == 1536) {
    start_counterattack = true;
    return;
  }
  if (len == 5 && state == 0) {
    start_counterattack = true;
    return;
  }
  if (len == 5 && state == 192) {
    start_counterattack = true;
    return;
  }
  if (len == 5 && state == 448) {
    start_counterattack = true;
    return;
  }
  if (len == 5 && state == 640) {
    start_counterattack = true;
    return;
  }
  if (len == 5 && state == 1216) {
    start_counterattack = true;
    return;
  }
  if (len == 5 && state == 1728) {
    start_counterattack = true;
    return;
  }
  if (len == 5 && state == 1920) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 160) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 256) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 416) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 704) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 768) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 1120) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 1152) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 1472) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 1664) {
    start_counterattack = true;
    return;
  }
  if (len == 6 && state == 1888) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 96) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 288) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 400) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 544) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 592) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 624) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 864) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 912) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 1008) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 1184) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 1520) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 1712) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 1792) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 1872) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 1984) {
    start_counterattack = true;
    return;
  }
  if (len == 7 && state == 2032) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 80) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 136) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 152) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 304) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 344) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 360) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 392) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 520) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 536) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 568) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 584) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 616) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 760) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 808) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 824) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 840) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 848) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 880) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 928) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 968) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 976) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1024) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1048) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1096) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1112) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1208) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1416) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1448) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1464) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1512) {
    start_counterattack = true;
    return;
  }
  if (len == 8 && state == 1704) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 112) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 120) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 148) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 316) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 324) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 332) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 336) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 352) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 372) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 380) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 384) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 564) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 580) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 612) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 736) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 744) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 756) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 800) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 820) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 832) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 856) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 892) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 896) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 904) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 940) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 956) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 988) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 996) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1004) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1036) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1040) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1064) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1088) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1104) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1204) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1412) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1424) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1432) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1444) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1460) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1508) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1808) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1816) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1840) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1848) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1856) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 1864) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 2004) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 2020) {
    start_counterattack = true;
    return;
  }
  if (len == 9 && state == 2028) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 68) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 78) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 88) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 94) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 116) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 126) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 128) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 144) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 314) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 322) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 328) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 340) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 378) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 518) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 528) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 562) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 576) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 608) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 742) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 750) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 754) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 804) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 838) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 860) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 888) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 900) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 910) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 944) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 954) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 960) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 964) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 984) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1000) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1032) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1058) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1062) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1074) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1082) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1092) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1202) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1410) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1430) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1436) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1456) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1504) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1698) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1702) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1812) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1820) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1824) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1828) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1832) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1836) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1844) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1852) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1860) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 1868) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 2002) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 2010) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 2012) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 2018) {
    start_counterattack = true;
    return;
  }
  if (len == 10 && state == 2026) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 64) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 67) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 70) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 73) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 77) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 91) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 93) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 124) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 147) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 312) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 321) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 331) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 343) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 356) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 368) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 371) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 388) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 391) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 513) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 515) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 517) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 530) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 533) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 579) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 610) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 741) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 749) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 752) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 807) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 816) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 837) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 863) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 890) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 903) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 908) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 937) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 946) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 953) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 962) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 966) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 987) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1035) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1044) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1047) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1056) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1061) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1070) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1073) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1079) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1080) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1087) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1108) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1111) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1201) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1408) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1428) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1439) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1441) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1443) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1459) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1507) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1815) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1823) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1826) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1831) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1834) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1839) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1847) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1855) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1863) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 1871) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 2001) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 2009) {
    start_counterattack = true;
    return;
  }
  if (len == 11 && state == 2014) {
    start_counterattack = true;
    return;
  }
  return;
}
// End generated code



void reset_state_machine() {
    state = 0;
    len = 0;
}

void TC3_Handler() {
    TC_GetStatus(TC1, 0);

    PIOC->PIO_CODR = sda;   // External Timer
    PIOC->PIO_SODR = sda;

    bool value = PIOA->PIO_PDSR & PIO_PA1A_CANRX0;

    if (sof == true) {    // Start arbitration
        counter2++;
        if (counter2 < 25 && !start_counterattack) {
            if (can_frame[counter2 - 2] != value && stuffcnt == 5) {
                stuffcnt = 0;
                counter2--;
            }
            else if (can_frame[counter2 - 2] == value && stuffcnt < 5) {
                can_frame[counter2 - 1] = value;
                state_machine_run(value);
                stuffcnt++;
            }
            else if (can_frame[counter2 - 2] != value && stuffcnt < 5) {
                can_frame[counter2 - 1] = value;
                state_machine_run(value);
                stuffcnt = 1;
            }
        }

        if (first_cycle == true) {
            first_cycle = false;
            NVIC_DisableIRQ(TC3_IRQn);
            startTimer(TC1, 0, TC3_IRQn, SPEED);
        }

        if (counter2 == 21) {
            PIOA->PIO_PDR = PIO_PA0A_CANTX0;
            PIOA->PIO_ODR = PIO_PA0A_CANTX0;
            sof = false;
            counter2 = 0;
            retransmission_count++;
        }

        else if (counter2 == 14) {
            if (start_counterattack == true) {    // Counterattack
                start_counterattack = false;
                PIOA->PIO_PER = PIO_PA0A_CANTX0;    // Multiplex CAN_TX to GPIO
                PIOA->PIO_OER = PIO_PA0A_CANTX0;    // Define CAN_TX as output
                PIOC->PIO_CODR = PIO_PA0A_CANTX0;   // set pin to LOW
            }
        }
    }
    else {    // Keep for retransmissions
        if (value == 1) {
            counter++;
        }
        else if (value == 0 && counter < 11) {
            counter = 0;
        }

        if (counter >= 11 && value == 0) {    //SOF
            sof = true;
            counter = 0;
            stuffcnt = 1;
            can_frame[0] = 0;
            counter2 = 1;
            reset_state_machine();
        }
    }

    PIOC->PIO_CODR = scl;   // External Timer
    PIOC->PIO_SODR = scl;
}

void startTimer(Tc* tc, uint32_t channel, IRQn_Type irq, uint32_t frequency) {

    //Enable or disable write protect of PMC registers.
    pmc_set_writeprotect(false);
    //Enable the specified peripheral clock.
    pmc_enable_periph_clk((uint32_t)irq);

    TC_Configure(tc, channel, TC_CMR_WAVE | TC_CMR_WAVSEL_UP_RC | TC_CMR_TCCLKS_TIMER_CLOCK4);
    uint32_t rc = VARIANT_MCK / 128 / frequency;

    TC_SetRA(tc, channel, rc / 2);
    TC_SetRC(tc, channel, rc);
    TC_Start(tc, channel);

    tc->TC_CHANNEL[channel].TC_IER = TC_IER_CPCS;
    tc->TC_CHANNEL[channel].TC_IDR = ~TC_IER_CPCS;
    NVIC_EnableIRQ(irq);
}

void MichiCAN_Sync() {
    first_cycle = true;
    sof = true;
    counter = 0;
    can_frame[0] = 0;
    counter2 = 1;
    stuffcnt = 1;
    reset_state_machine();
    NVIC_DisableIRQ(TC3_IRQn);
    startTimer(TC1, 0, TC3_IRQn, (1 / SAMPLING_POINT) * SPEED);
    detachInterrupt(PIO_PA1A_CANRX0);
}

void setup() {

    // start serial port at 115200 bps:
    Serial.begin(115200);

    // Verify CAN0 and CAN1 initialization, baudrate is 1Mb/s:
    if (Can0.begin(SPEED) &&
        Can1.begin(SPEED)) {
    }
    else {
        Serial.println("CAN initialization (sync) ERROR");
    }

    PMC->PMC_PCER0 |= PMC_PCER0_PID11; // PIOA power ON

    //Multiplex CAN_RX to GPIO (Peripheral Enable Register)
    PIOA->PIO_PER = PIO_PA1A_CANRX0;

    //Set CAN_RX as input (Ouput Disable Register)
    PIOA->PIO_ODR = PIO_PA1A_CANRX0;

    //Disable pull-up on both pins (Pull Up Disable Register)
    PIOA->PIO_PUDR = PIO_PA1A_CANRX0;
    PIOA->PIO_PUDR = PIO_PA0A_CANTX0;

    //Use Pins 33 and 35 for external time measurement on ESP32
    PIOC->PIO_PER = scl;
    PIOC->PIO_PER = sda;

    //Set Pins 33 and 35 as output (Ouput Enable Register)
    PIOC->PIO_OER = scl;
    PIOC->PIO_OER = sda;

    Can0.watchFor();
}

void loop()
{
    if (sof == false) {
        attachInterrupt(PIO_PA1A_CANRX0, MichiCAN_Sync, FALLING); //Indicates SOF
    }
}
